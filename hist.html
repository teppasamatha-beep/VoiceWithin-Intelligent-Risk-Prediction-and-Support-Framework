<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VoiceWithin ‚Äî History</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #234;
      color: white;
      text-align: center;
    }

    /* Navbar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: #fff;
      color: #234;
    }

    .navbar-left {
      font-size: 22px;
      font-weight: bold;
      font-style: italic;
      color: #234;
    }

    .navbar-right {
      display: flex;
      align-items: center;
    }

    .navbar-right a {
      margin-left: 20px;
      text-decoration: none;
      color: #234;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }

    /* Dropdown */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #fff;
      min-width: 180px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1;
      text-align: left;
    }

    .dropdown-content a {
      display: block;
      padding: 12px 18px;
      color: #234;
      text-decoration: none;
      font-size: 16px;
      transition: background 0.3s;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    .profile-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: #234;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      margin-left: 20px;
      cursor: pointer;
    }

    main {
      padding: 20px;
    }

    .month {
      margin-bottom: 30px;
    }

    .month h3 {
      margin-bottom: 10px;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .entry {
      background-color: white;
      color: black;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      position: relative;
    }

    .entry span {
      display: block;
      font-size: 24px;
    }

    .entry-buttons {
      margin-top: 8px;
      display: flex;
      justify-content: space-around;
    }

    .entry-buttons button {
      background-color: #234;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .entry-buttons button:hover {
      background-color: #456;
    }

    .empty-msg {
      text-align: center;
      margin-top: 100px;
      color: #ccc;
      font-style: italic;
    }

    /* Modal Overlay */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* Modal Content Box */
    .modal-content {
      background-color: #fefefe;
      color: #123;
      width: 500px;
      border-radius: 15px;
      padding: 25px 30px;
      text-align: center;
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-content h2 {
      margin-bottom: 5px;
    }

    .modal-content p {
      color: gray;
      margin-bottom: 15px;
    }

    .mood-icons span {
      font-size: 28px;
      margin: 0 5px;
      cursor: pointer;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: none;
      margin-bottom: 15px;
    }

    .modal-buttons button {
      background-color: #234;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      margin: 5px;
    }

    .modal-buttons button:hover {
      background-color: #456;
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 18px;
      font-size: 22px;
      cursor: pointer;
      color: #123;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="navbar-left">VoiceWithin</div>
    <div class="navbar-right">
      <a href="/survey">Test</a>
      <div class="dropdown">
        <a>Journal ‚ñæ</a>
        <div class="dropdown-content">
          <a href="/history">History</a>
          <a href="/journal">New Entry</a>
        </div>
      </div>
      <a href="/chatbot">AI</a>
      <div class="dropdown">
        <div class="profile-icon">üë§</div>
        <div class="dropdown-content">
          <a href="/improvement">Dashboard</a>
          <a href="/login">Log out</a>
        </div>
      </div>
    </div>
  </div>

  <main>
    <section id="history"></section>
    <p id="emptyMessage" class="empty-msg hidden">No journal entries yet.</p>

    <!-- Journal Entry Modal -->
    <div id="journalModal" class="modal hidden">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">√ó</span>
        <h2 id="modalTitle" contenteditable="false"></h2>
        <p id="modalDate"></p>

        <div class="mood-icons">
          <span onclick="selectMood('neutral')">üòê</span>
          <span onclick="selectMood('happy')">üòä</span>
          <span onclick="selectMood('smile')">üòÑ</span>
          <span onclick="selectMood('angry')">üò°</span>
          <span onclick="selectMood('sad')">üò≠</span>
        </div>

        <textarea id="modalContent" rows="6" readonly></textarea>

        <div class="modal-buttons">
          <button id="saveBtn" onclick="saveEditedEntry()" class="hidden">Save</button>
          <button onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script>
let currentEntryId = null;
let editMode = false;
let selectedMood = null;

// Fetch entries from backend
async function renderHistory() {
  const res = await fetch('/entries');
  const data = await res.json();

  const container = document.getElementById('history');
  const emptyMessage = document.getElementById('emptyMessage');
  container.innerHTML = '';

  if (!data.length) {
    emptyMessage.classList.remove('hidden');
    return;
  } else {
    emptyMessage.classList.add('hidden');
  }

  const grouped = {};
  data.forEach(entry => {
    // ‚úÖ FIXED: use created_at
    const date = new Date(entry.created_at);
    if (isNaN(date)) return; // skip invalid dates
    const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
    if (!grouped[monthYear]) grouped[monthYear] = [];
    grouped[monthYear].push(entry);
  });

  for (const [month, entries] of Object.entries(grouped)) {
    const monthDiv = document.createElement('div');
    monthDiv.className = 'month';
    monthDiv.innerHTML = `<h3>${month}</h3><div class="month-grid"></div>`;
    const grid = monthDiv.querySelector('.month-grid');

    entries.forEach(entry => {
      const date = new Date(entry.created_at);
      const day = date.getDate();
      const moodIcon = moodToEmoji(entry.mood);
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `
        <span>${moodIcon}</span>
        ${String(day).padStart(2, '0')}<br>
        ${entry.title}
        <div class="entry-buttons">
          <button onclick="openEntry('${entry._id}', false)">Open</button>
          <button onclick="openEntry('${entry._id}', true)">Edit</button>
          <button onclick="deleteEntry('${entry._id}')">Delete</button>
        </div>
      `;
      grid.appendChild(div);
    });

    container.appendChild(monthDiv);
  }
}

function moodToEmoji(mood) {
  switch (mood) {
    case 'neutral': return 'üòê';
    case 'happy': return 'üòä';
    case 'smile': return 'üòÑ';
    case 'angry': return 'üò°';
    case 'sad': return 'üò≠';
    default: return 'üôÇ';
  }
}

async function openEntry(id, isEdit) {
  const res = await fetch('/entries');
  const data = await res.json();
  const entry = data.find(e => e._id === id);
  if (!entry) return;

  currentEntryId = id;
  editMode = isEdit;
  selectedMood = entry.mood;

  document.getElementById('modalTitle').innerText = entry.title;
  document.getElementById('modalDate').innerText = new Date(entry.created_at).toLocaleString();
  document.getElementById('modalContent').value = entry.content;
  document.getElementById('modalTitle').contentEditable = isEdit;
  document.getElementById('modalContent').readOnly = !isEdit;
  document.getElementById('saveBtn').classList.toggle('hidden', !isEdit);

  document.querySelectorAll('.mood-icons span').forEach(span => {
    span.style.opacity = (moodToEmoji(entry.mood) === span.innerText) ? "1" : "0.4";
  });

  // Display images
  let imgHTML = "";
  if (entry.images && entry.images.length) {
    imgHTML = entry.images.map(img => `<img src="${img}" width="80" style="border-radius:10px;margin:5px;">`).join("");
  }
  document.querySelector('.modal-content').insertAdjacentHTML("beforeend", `<div id="imagePreview">${imgHTML}</div>`);

  // Add file input if in edit mode
  if (isEdit) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'modalImageInput';
    fileInput.multiple = true;
    fileInput.accept = 'image/*';
    document.querySelector('.modal-content').appendChild(fileInput);
  }

  document.getElementById('journalModal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('journalModal').classList.add('hidden');
  document.getElementById('imagePreview')?.remove();
  document.getElementById('modalImageInput')?.remove();
}

function selectMood(mood) {
  if (!editMode) return;
  selectedMood = mood;
  document.querySelectorAll('.mood-icons span').forEach(span => {
    span.style.opacity = (moodToEmoji(mood) === span.innerText) ? "1" : "0.4";
  });
}

async function saveEditedEntry() {
  if (!currentEntryId) return;

  const formData = new FormData();
  formData.append('title', document.getElementById('modalTitle').innerText.trim());
  formData.append('content', document.getElementById('modalContent').value.trim());
  formData.append('mood', selectedMood);

  const fileInput = document.getElementById('modalImageInput');
  if (fileInput && fileInput.files.length > 0) {
    for (let i = 0; i < fileInput.files.length; i++) {
      formData.append('images', fileInput.files[i]);
    }
  }

  await fetch(`/edit/${currentEntryId}`, { method: 'POST', body: formData });
  closeModal();
  renderHistory();
}

async function deleteEntry(id) {
  if (!confirm("Are you sure you want to delete this entry?")) return;
  const res = await fetch(`/delete/${id}`, { method: "POST" });
  const data = await res.json();
  if (!data.success) {
    alert("Delete failed.");
    return;
  }
  renderHistory();
}


renderHistory();
</script>


</body>
</html>  